groups:
  - name: soroban_registry_alerts
    rules:
      - alert: HighP99Latency
        expr: histogram_quantile(0.99, sum(rate(soroban_verification_latency_seconds_bucket[5m])) by (le)) > 0.5
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "Verification P99 latency exceeds 500ms"
          description: "P99 verification latency is {{ $value | humanizeDuration }} (threshold 500ms)."
          runbook_url: "https://wiki.internal/runbooks/high-verification-latency"

      - alert: HighErrorRate
        expr: (sum(rate(soroban_http_requests_total{status=~"5.."}[5m])) / sum(rate(soroban_http_requests_total[5m]))) * 100 > 5
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "HTTP 5xx error rate exceeds 5%"
          description: "Current error rate is {{ $value | printf \"%.2f\" }}%."

      - alert: DatabaseConnectionExhaustion
        expr: soroban_db_connections_active / soroban_db_pool_size > 0.8
        for: 3m
        labels:
          severity: warning
          team: infra
        annotations:
          summary: "DB connection pool >80% utilized"
          description: "{{ $value | printf \"%.0f\" }}% of pool connections in use."

      - alert: CacheHitRateLow
        expr: rate(soroban_cache_hits_total[10m]) / (rate(soroban_cache_hits_total[10m]) + rate(soroban_cache_misses_total[10m])) < 0.5
        for: 10m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "Cache hit ratio below 50%"
          description: "Cache hit rate is {{ $value | printf \"%.2f\" }}."

      - alert: SLOBurnRateHigh
        expr: soroban_slo_burn_rate{slo="availability"} > 1
        for: 1h
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "SLO burn rate >1 for availability"
          description: "Current burn rate is {{ $value | printf \"%.2f\" }}. Error budget being consumed faster than sustainable."

      - alert: VerificationQueueBacklog
        expr: soroban_verification_queue_depth > 100
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "Verification queue depth exceeds 100"
          description: "Queue depth is {{ $value }}."

      - alert: HighMigrationFailureRate
        expr: rate(soroban_migration_failures_total[10m]) / rate(soroban_migration_total[10m]) > 0.1
        for: 10m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "Migration failure rate exceeds 10%"
          description: "{{ $value | printf \"%.0f\" }}% of migrations failing."
